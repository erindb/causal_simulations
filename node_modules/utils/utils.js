var fs = require('fs');
var physics = require('./physics_engine.js')
// var babyparse = require('babyparse');
// var jStat = require('jStat').jStat;

var results_dir = "results/";
var modules_dir = "node_modules";
for (var i = 0; i < process.argv.length; i++) {
	if (process.argv[i] == "--results_dir") {
		results_dir = process.argv[i+1];
	}
	if (process.argv[i] == "--modules_dir") {
		modules_dir = process.argv[i+1];
	}
}
if (fs.lstatSync(results_dir).isDirectory()) {
	console.log("results will be written to: " + results_dir);
} else {
	console.log("results directory `" + results_dir + "` does not exist.");
}
if (fs.lstatSync(modules_dir).isDirectory()) {
	console.log("reading templates from node dir: " + modules_dir);
} else {
	console.log("modules directory `" + modules_dir + "` does not exist.");
}


physics.run_physics_engine();

var convert_to_physics = function(w) {
	// do any conversions to create the bodies or whatever
	return w;
}

var convert_to_wppl = function(w) {
	// grab velocities and positions
	return w;
}

var run_physics = function(w) {
	var world = physics.setup_physics(w);
	for (var i=0; i < 60; i++) {
		world.step(1/60);
	}

	var bodies = {};
	for (var i=0; i<world.bodies.length; i++) {
		var body = world.bodies[i];
		bodies[body.id] = {
			velocity: body.velocity[0]/10,
			position: (body.position[0]+2)/4
		}
	}

	// returns wppl representation of world at a later timepoint
	return bodies;
};

var worlds = [];
var write = function(world, label) {
	worlds.push({"world": world, "label": label});
}

var finish = function(output_file_tag) {
	var output_file_tag = output_file_tag || "tmp";
	var output_js_filename = output_file_tag + ".js";
	var output_html_filename = output_file_tag + ".html";

	console.log("writing worlds...");

	// will write json for html to read

	// write worlds to some file somewhere in such a way
	// that i can  view their animations.
	var s = "var results = " + JSON.stringify(worlds, undefined, indent=2);
	// write s to a file
	fs.writeFile(results_dir + output_js_filename, s)
	// fs.writeFile("results/tmp.html", s)

	fs.readFile(modules_dir + "utils/results_template/results_template.html", 'utf8', function(err, data) {
		fs.writeFile(results_dir + output_html_filename, data.replace(
			"<script src='tmp.js'></script>",
			"<script src='" + output_js_filename + "'></script>"
		));
	});

	return "worlds written";
}

module.exports = {
	run_physics: run_physics,
	write: write,
	finish: finish
};
